<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Elevator - Mobility-Hackathon</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css">
    <style type="text/css">
        html, body, #map {
            height: 100%;
        }

        body {
            margin: 0;
            position: relative;
        }

        .statusBubble {
            width: 25px;
            height: 25px;
            border-radius: 25px;
            float: left;
            margin: 0 10px;
        }

        .clearfix:after {
            visibility: hidden;
            display: block;
            content: " ";
            height: 0;
            font-size: 0;
            clear: both
        }

        #modal {
            position: absolute;
            width: 100%;
            height: 100%;
            max-width: 80%;
            max-height: 80%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 10px;
            z-index: 9999;
            display: none;
            text-align: center;
        }

        #modal img {
            max-width: 100%;
            max-height: 100%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #modal ul {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 100%;
            list-style: none;
            padding: 5px;
            margin: 0;
            font-size: 0;
            text-align: center;
            background: white;
        }

        #modal ul li {
            font-size: 1rem;
            display: inline-block;
            vertical-align: top;
        }
    </style>
</head>
<body>
<div id="modal"></div>
<div id="map"></div>

<script type="text/javascript" src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>

<script>
    function drawRoute(lat, long, end) {
        const request = new XMLHttpRequest();
        request.open('GET', `/route/${lat}/${long}/${end}`, true);
        request.onload = function() {
                if (request.status >= 200 && request.status < 400) {
                    const data = JSON.parse(request.responseText);
                    const paths = data[0].paths;
                    let points = []
                    for (let track in paths) {
                        for (let coord of paths[track].track) {
                            let point = new L.LatLng(coord.y, coord.x);
                            points.push(point);
                        }
                    }
                    var firstpolyline = new L.Polyline(points, {
                        color: 'red',
                        weight: 3,
                        opacity: 0.5,
                        smoothFactor: 1
                    });
                    firstpolyline.addTo(mymap);
                }
            };
            request.send();
    }

    // GeoLocation related code
    if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const options = {
                fillOpacity: 0.7,
                radius: 80,
                color: 'blue',
                fillColor: '#3F7FBF'
            };
            L.circle([position.coords.latitude, position.coords.longitude], options).addTo(mymap);

            const request = new XMLHttpRequest();
            request.open('GET', `/stations/closest/${position.coords.latitude}/${position.coords.longitude}`, true);
            request.onload = function() {
                if (request.status >= 200 && request.status < 400) {
                    const data = JSON.parse(request.responseText);
                    const target = data[0];

                    drawRoute(position.coords.latitude, position.coords.longitude, data[0].id);
                }
            };
            request.send();
        });
    } else {
        console.warn('no geolocation available');
    }
</script>

<script>
    const renderStations = function () {
        const request = new XMLHttpRequest();

        request.open('GET', '/stations', true);
        request.onload = () => {
            if (request.status >= 200 && request.status < 400) {
                // Success!
                const data = JSON.parse(request.responseText);

                // Build a circle for every station
                data.forEach((station) => {
                    if (station.id === 'Master:80950') {
                        console.log(station);
                    }


                    // Build the circle options
                    const options = {
                        fillOpacity: 0.7,
                        radius: 80
                    };

                    switch (station.status) {
                        case 1:
                            options.color = 'green';
                            options.fillColor = '#88CC88';
                            break;
                        case 0:
                            options.color = 'yellow';
                            options.fillColor = '#FFFFAA';
                            break;
                        default:
                            options.color = 'red';
                            options.fillColor = '#f03';
                    }

                    // Build circles
                    L.circle([station.coordinate.y, station.coordinate.x], options)
                        .addTo(mymap)
                        .on('click', renderStationInformation(station));
                });
            } else {
                console.error('We reached our target server, but it returned an error');
            }
        };

        request.onerror = () => {
            console.error('There was a connection error of some sort');
        };

        request.send();
    };

    const renderStationInformation = (station) => {
        return () => {
            const request = new XMLHttpRequest();

            request.open('GET', '/stations/' + station.id, true);
            request.onload = () => {
                if (request.status >= 200 && request.status < 400) {
                    // Success!
                    const data = JSON.parse(request.responseText);

                    console.log(data);

                    const $modal = document.getElementById('modal');
                    if (typeof data[0] !== 'undefined' && typeof data[0].stationOutline !== 'undefined') {
                        $modal.innerHTML = '<img src="' + data[0].stationOutline + '">';
                    }

                    let statusBubblesHTML = '';

                    if (typeof data[0] !== 'undefined' && typeof data[0].elevators !== 'undefined') {
                        data[0].elevators.forEach((elevator) => {
                            let color = 'grey';

                            if (elevator.state === 'READY') {
                                color = 'green';
                            }

                            if (elevator.state === 'OUTOFORDER') {
                                color = 'red';
                            }

                            statusBubblesHTML = statusBubblesHTML
                                + '<li><span class="statusBubble" style="background: ' + color + '"></span></li>';
                        });

                        $modal.innerHTML = $modal.innerHTML + '<ul>' + statusBubblesHTML + '</ul>';

                        $modal.style.display = 'block';
                    }
                } else {
                    console.error('We reached our target server, but it returned an error');
                }
            };

            request.onerror = () => {
                console.error('There was a connection error of some sort');
            };

            request.send();
        };
    };
    renderStations();
</script>

<script type="text/javascript">
    const mymap = L.map('map').setView([53.551085, 9.993682], 13);

    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
        maxZoom: 18,
        attribution: '<a href="http://mobility-hackathon.de/">Mobility-Hackathon Hamburg</a>' +
        ' - Elevator - Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
        '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
        'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
        id: 'mapbox.streets'
    }).addTo(mymap);

    const $modal = document.getElementById('modal');
    window.onclick = () => {
        $modal.style.display = "none";
    }
</script>
</body>
</html>
