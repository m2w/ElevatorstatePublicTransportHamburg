<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Elevator - Mobility-Hackathon</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css">
    <style type="text/css">
        html, body, #map {
            height: 100%;
        }

        body {
            margin: 0;
        }
    </style>
</head>
<body>
<div id="test"></div>
<div id="map"></div>

<script>
    // GeoLocation related code
    if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const request = new XMLHttpRequest();
            request.open('GET', `/stations/closest/${position.coords.latitude}/${position.coords.longitude}`, true);
            request.onload = function() {
                if (request.status >= 200 && request.status < 400) {
                    const data = JSON.parse(request.responseText);
                    console.log(data);
                }
            };
            request.send();
        });
    } else {
        console.warn('no geolocation available');
    }
</script>

<script type="text/javascript" src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>

<script>
    const renderStations = function () {
        const request = new XMLHttpRequest();

        request.open('GET', '/stations', true);
        request.onload = () => {
            if (request.status >= 200 && request.status < 400) {
                // Success!
                const data = JSON.parse(request.responseText);

                // Build a circle for every station
                data.forEach((station) => {
                    // Build the circle options
                    const options = {
                        fillOpacity: 0.7,
                        radius: 80
                    };

                    switch (station.status) {
                        case 1:
                            options.color = 'green';
                            options.fillColor = '#88CC88';
                            break;
                        case 0:
                            options.color = 'yellow';
                            options.fillColor = '#FFFFAA';
                            break;
                        default:
                            options.color = 'red';
                            options.fillColor = '#f03';
                    }

                    // Build circles
                    L.circle([station.coordinate.y, station.coordinate.x], options)
                        .bindPopup('', {maxWidth: '500px', maxHeight: '500px'})
                        .addTo(mymap)
                        .on('click', renderStationInformation(station));
                });
            } else {
                // We reached our target server, but it returned an error
            }
        };

        request.onerror = () => {
            // There was a connection error of some sort
        };

        request.send();
    };


    const renderStationInformation = (station) => {
        return (e) => {
            const popup = e.target.getPopup();
            const request = new XMLHttpRequest();

            request.open('GET', '/stations/' + station.id, true);
            request.onload = () => {
                if (request.status >= 200 && request.status < 400) {
                    // Success!
                    const data = JSON.parse(request.responseText);

                    popup.setContent(`<img src="${data[0].stationOutline}" height="400px" alt="station">`);
                    popup.update();
                } else {
                    // We reached our target server, but it returned an error
                }
            };

            request.onerror = () => {
                // There was a connection error of some sort
            };

            request.send();
        };
    };


    renderStations();
</script>

<script type="text/javascript">
    const mymap = L.map('map').setView([53.551085, 9.993682], 13);

    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
        maxZoom: 18,
        attribution: '<a href="http://mobility-hackathon.de/">Mobility-Hackathon Hamburg</a>' +
        ' - Elevator - Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
        '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
        'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
        id: 'mapbox.streets'
    }).addTo(mymap);
</script>
</body>
</html>
