<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Elevator - Mobility-Hackathon</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css">
    <style type="text/css">
        html, body, #map {
            height: 100%;
        }

        body {
            margin: 0;
            position: relative;
        }

        .circle {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin: 0 10px;
            display: inline-block;
        }

        #modal {
            position: absolute;
            width: 100%;
            height: 100%;
            max-width: 80%;
            max-height: 80%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 10px;
            z-index: 9000;
            display: none;
            text-align: center;
        }

        #modal img {
            max-width: 100%;
            max-height: 100%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #modal .elevators {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 96%;
            padding: 2%;
            background: white;
            text-align: left;
        }

        #modal .combinedName {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 9999;
            width: 100%;
            text-align: center;
            padding: 10px 0;
            background: white;
            font-weight: bold;
        }

        .leaflet-popup-close-button {
            display: none;
        }
    </style>
</head>
<body>
<div id="modal"></div>
<div id="map"></div>

<script type="text/javascript" src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>

<script>
    const preferedTrackAttributes   = ['COBBLESTONE'];


    function arraysEqual(arr1, arr2) {
        if(arr1.length !== arr2.length)
            return false;
        for(let i = arr1.length; i--;) {
            if(arr1[i] !== arr2[i])
                return false;
        }

        return true;
    }

    function drawRoute(lat, long, end) {
        const request = new XMLHttpRequest();
        request.open('GET', `/route/${lat}/${long}/${end}`, true);
        request.onload = function () {
            if (request.status >= 200 && request.status < 400) {
                const data = JSON.parse(request.responseText);
                const paths = data[0].paths;
                let points = [];
                for (let track in paths) {
                    for (let coord of paths[track].track) {
                        let point = new L.LatLng(coord.y, coord.x);
                        points.push(point);
                    }
                }
                let firstpolyline = new L.Polyline(points, {
                    color: 'red',
                    weight: 3,
                    opacity: 0.5,
                    smoothFactor: 1
                });
                firstpolyline.addTo(mymap);
            }
        };
        request.send();
    }

    function drawIndividualRoute(start, destination) {
        const request = new XMLHttpRequest();
        request.open('GET', `/route/${start}/${destination}`, true);
        request.onload = function () {
            if (request.status >= 200 && request.status < 400) {
                const data = JSON.parse(request.responseText);
                data[0].paths.forEach((path) => {
                    if (arraysEqual(preferedTrackAttributes, path.attributes)) {
                        console.log(path.track);
                        path.track.forEach((coordinates) => {
                            drawRoute(coordinates.y, coordinates.x, destination);
                        });
                    }
                });
            }
        };
        request.send();
    }

    // GeoLocation related code
    if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(function (position) {
            const options = {
                fillOpacity: 0.7,
                radius: 80,
                color: 'blue',
                fillColor: '#3F7FBF'
            };
            L.circle([position.coords.latitude, position.coords.longitude], options).addTo(mymap);

            const request = new XMLHttpRequest();
            request.open('GET', `/stations/closest/${position.coords.latitude}/${position.coords.longitude}`, true);
            request.onload = function () {
                if (request.status >= 200 && request.status < 400) {
                    const data = JSON.parse(request.responseText);
                    const target = data[0];

                    drawIndividualRoute('Master:8000238', 'Master:80950');
                    //drawIndividualRoute('Master:83900', 'Master:80950');

                    drawRoute(position.coords.latitude, position.coords.longitude, data[0].id);
                }
            };
            request.send();
        });
    } else {
        console.warn('no geolocation available');
    }
</script>

<script>
    const renderStations = function () {
        const request = new XMLHttpRequest();

        request.open('GET', '/stations', true);
        request.onload = () => {
            if (request.status >= 200 && request.status < 400) {
                // Success!
                const data = JSON.parse(request.responseText);

                // Build a circle for every station
                data.forEach((station) => {
                    console.log(station.id);
                    
                    // Build the circle options
                    const options = {
                        fillOpacity: 0.7,
                        radius: 80
                    };

                    switch (station.status) {
                        case 1:
                            options.color = 'green';
                            options.fillColor = '#88CC88';
                            break;
                        case 0:
                            options.color = 'yellow';
                            options.fillColor = '#FFFFAA';
                            break;
                        default:
                            options.color = 'red';
                            options.fillColor = '#f03';
                    }

                    // Build circles
                    L.circle([station.coordinate.y, station.coordinate.x], options)
                        .on('mouseover', (e) => {
                            const popup = L.popup()
                                .setLatLng(e.latlng)
                                .setContent(station.combinedName)
                                .openOn(mymap);
                        })
                        .addTo(mymap)
                        .on('click', renderStationInformation(station));
                });
            } else {
                console.error('We reached our target server, but it returned an error');
            }
        };

        request.onerror = () => {
            console.error('There was a connection error of some sort');
        };

        request.send();
    };

    const renderStationInformation = (station) => {
        return () => {
            const request = new XMLHttpRequest();

            request.open('GET', '/stations/' + station.id, true);
            request.onload = () => {
                if (request.status >= 200 && request.status < 400) {
                    // Success!
                    const data = JSON.parse(request.responseText);

                    const $modal = document.getElementById('modal');
                    if (typeof data[0] !== 'undefined' && typeof data[0].stationOutline !== 'undefined') {
                        $modal.innerHTML = '<img src="' + data[0].stationOutline + '">';
                    }

                    let statusBubblesHTML = '';

                    if (typeof data[0] !== 'undefined' && typeof data[0].elevators !== 'undefined') {
                        data[0].elevators.forEach((elevator) => {
                            let color = 'grey';

                            if (elevator.state === 'READY') {
                                color = 'green';
                            }

                            if (elevator.state === 'OUTOFORDER') {
                                color = 'red';
                            }

                            let lines = '';
                            if (typeof elevator.lines !== 'undefined') {
                                lines = elevator.lines.join(', ');
                            }

                            statusBubblesHTML = statusBubblesHTML
                                + '<div><div class="circle" style="background: ' + color + '"></div> ' + lines + '</div>';
                        });

                        $modal.innerHTML = $modal.innerHTML + '<div class="combinedName">' + station.combinedName + '</div>' + '<div class="elevators">' + statusBubblesHTML + '</div></ul>';

                        $modal.style.display = 'block';
                    }
                } else {
                    console.error('We reached our target server, but it returned an error');
                }
            };

            request.onerror = () => {
                console.error('There was a connection error of some sort');
            };

            request.send();
        };
    };
    renderStations();
</script>

<script type="text/javascript">
    const mymap = L.map('map').setView([53.551085, 9.993682], 13);

    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
        maxZoom: 18,
        attribution: '<a href="http://mobility-hackathon.de/">Mobility-Hackathon Hamburg</a>' +
        ' - Elevator - Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
        '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
        'Imagery © <a href="http://mapbox.com">Mapbox</a>',
        id: 'mapbox.streets'
    }).addTo(mymap);

    const $modal = document.getElementById('modal');
    window.onclick = () => {
        $modal.style.display = "none";
    }
</script>
</body>
</html>
